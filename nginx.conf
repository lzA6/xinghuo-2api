# =================================================================
# Xinghuo-2api - ç»ˆæç²˜æ€§ä¼šè¯ä¸æ€§èƒ½ç‰ˆ Nginx é…ç½®
# æ ¸å¿ƒ: ç»å¯¹ä¿¡ä»»åç«¯ï¼Œé›¶å¹²é¢„ï¼Œæè‡´ååï¼Œå¹¶é‡‡ç”¨æœ€å¥å£®çš„ä¼šè¯ä¿æŒç­–ç•¥
# =================================================================

# --- å…¨å±€æ€§èƒ½è®¾ç½® ---
worker_processes auto;
worker_rlimit_nofile 102400;

# --- äº‹ä»¶æ¨¡å‹ä¼˜åŒ– ---
events {
    worker_connections 102400;
    use epoll;
    multi_accept on;
}

# --- HTTP æ ¸å¿ƒé…ç½® ---
http {
    # --- åŸºç¡€æ€§èƒ½ä¼˜åŒ– ---
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 15s;
    client_body_timeout 10s;
    client_header_timeout 10s;
    server_tokens off;
    access_log off;


    # --- ä¸Šæ¸¸æœåŠ¡å™¨ç»„ (æˆ‘ä»¬çš„ AI å·¥äºº) ---
    upstream xinghuo_backend {
        # å…³é”®ä¿®æ­£ ğŸš€: ä½¿ç”¨ Cookie å®ç°â€œç»ˆæç²˜æ€§ä¼šè¯â€
        # è®¯é£æ˜Ÿç«ä½¿ç”¨ Cookie è¿›è¡Œè®¤è¯å’Œä¼šè¯è·Ÿè¸ªã€‚
        # ä½¿ç”¨ $http_cookie ä½œä¸ºå“ˆå¸Œé”®ï¼Œç¡®ä¿æ¥è‡ªåŒä¸€ç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚
        # (æºå¸¦ç›¸åŒCookie) éƒ½è¢«è½¬å‘åˆ°åŒä¸€ä¸ªåç«¯ FastAPI å®ä¾‹ï¼Œ
        # è¿™å¯¹äºç»´æŠ¤å¯¹è¯çŠ¶æ€è‡³å…³é‡è¦ã€‚
        hash $http_cookie consistent;

        # æ€§èƒ½ç­–ç•¥: å¼€å¯ä¸å·¥äººçš„â€œVIPè¿æ¥æ± â€ï¼Œå®ç°æè‡´è¿æ¥å¤ç”¨
        keepalive 128;

        # ä¿¡ä»»ç­–ç•¥: ç§»é™¤æ‰€æœ‰å¥åº·æ£€æŸ¥å’Œç†”æ–­æœºåˆ¶
        server xinghuo-local:8082;
    }


    # --- ä¸»æœåŠ¡å™¨é…ç½® (API ç½‘å…³) ---
    server {
        listen 80;

        location / {
            # æ€§èƒ½ç­–ç•¥: ç§»é™¤æ‰€æœ‰è¯·æ±‚é™æµ
            proxy_pass http://xinghuo_backend;

            # --- æµå¼ä¼ è¾“ç»ˆæä¼˜åŒ– ---
            proxy_buffering off;
            proxy_cache off;

            # --- åè®®ä¸å¤´ä¿¡æ¯è®¾ç½® ---
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}